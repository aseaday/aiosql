<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="William Vaughn">
  <link rel="canonical" href="https://nackjicholson.github.io/aiosql/advanced-topics/">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Advanced Topics - aiosql docs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../css/custom.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Advanced Topics";
    var mkdocs_page_input_path = "advanced-topics.md";
    var mkdocs_page_url = "/aiosql/advanced-topics/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> aiosql docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting Started</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../defining-sql-queries/">Defining SQL Queries</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Advanced Topics</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#leveraging-driver-specific-features">Leveraging Driver Specific Features</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#access-the-cursor-object">Access the cursor object</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#accessing-prepared-sql-as-a-string">Accessing prepared SQL as a string</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sync-async">Sync &amp; Async</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#sync-with-sqlite3">Sync with sqlite3</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#asyncio-with-aiosqlite">Asyncio with aiosqlite</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#type-hinting-queries-with-protocols">Type Hinting Queries with Protocols</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../database-driver-adapters/">Database Driver Adapters</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../api/">API</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">aiosql docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Advanced Topics</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/nackjicholson/aiosql/edit/master/docs/advanced-topics.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="advanced-topics">Advanced Topics<a class="headerlink" href="#advanced-topics" title="Permanent link">&para;</a></h1>
<h2 id="leveraging-driver-specific-features">Leveraging Driver Specific Features<a class="headerlink" href="#leveraging-driver-specific-features" title="Permanent link">&para;</a></h2>
<p>Todo</p>
<h2 id="access-the-cursor-object">Access the <code>cursor</code> object<a class="headerlink" href="#access-the-cursor-object" title="Permanent link">&para;</a></h2>
<p>The cursor is a temporary object created in memory that allows you to perform row-by-row operations on your data and use handy methods such as <code>.description</code>, <code>.fetchall()</code> and <code>.fetchone()</code>. As long as you are running a SQL <code>SELECT</code> query, you can access the cursor object by appending <code>_cursor</code> to the end of the queries name. For example, say you have the following query named <code>get-all-greetings</code> in a <code>sql</code> file:</p>
<pre><code class="sql">-- greetings.sql

-- name: get-all-greetings
-- Get all the greetings in the database
SELECT
    greeting_id,
    greeting
FROM greetings;
</code></pre>

<p>With this query, you can get all <code>greeting_id</code>'s and <code>greeting</code>'s, access the cursor object, and print the column names with the following code:</p>
<pre><code class="python">import asyncio
import aiosql
import aiosqlite
from typing import List

queries = aiosql.from_path(&quot;greetings.sql&quot;, &quot;aiosqlite&quot;)

async def access_cursor():
    async with aiosqlite.connect(&quot;greetings.db&quot;) as conn:
        # append _cursor after query name
        async with queries.get_all_greetings_cursor(conn) as cur:
            print([col_info[0] for col_info in cur.description])
            first_row = await cur.fetchone()
            all_data = await cur.fetchall()
            print(f&quot;ALL DATA: {all_data}&quot;) # list of tuples
            print(f&quot;FIRST ROW: {first_row}&quot;) # tuple of first row data


asyncio.run(access_cursor())
# [greeting_id, greeting]
# ALL DATA: [(1, hi), (2, aloha), (3, hola)]
# FIRST ROW: (1, hi)
</code></pre>

<h2 id="accessing-prepared-sql-as-a-string">Accessing prepared SQL as a string<a class="headerlink" href="#accessing-prepared-sql-as-a-string" title="Permanent link">&para;</a></h2>
<p>When you need to do something not directly supported by aiosql, this is your escape hatch. You can still define your sql in a file and load it with aiosql, but then you may choose to use it without calling your aiosql method. The prepared SQL string of a method is available as an attribute of each method <code>queries.&lt;method_name&gt;.sql</code>. Here's an example of how you might use it with a unique feature of <code>psycopg2</code> like <a href="https://www.psycopg.org/docs/extras.html#psycopg2.extras.execute_values"><code>execute_values</code></a>.</p>
<p>This example adapts the example usage from psycopg2's documentation for <a href="https://www.psycopg.org/docs/extras.html#psycopg2.extras.execute_values"><code>execute_values</code></a>.</p>
<pre><code class="python">&gt;&gt;&gt; import aiosql
&gt;&gt;&gt; import psycopg2
&gt;&gt;&gt; from psycopg2.extras import execute_values
&gt;&gt;&gt; sql_str = &quot;&quot;&quot;
... -- name: create_schema#
... create table test (id int primary key, v1 int, v2 int);
...
... -- name: insert!
... INSERT INTO test (id, v1, v2) VALUES %s;
...
... -- name: update!
... UPDATE test SET v1 = data.v1 FROM (VALUES %s) AS data (id, v1)
... WHERE test.id = data.id;
...
... -- name: getem
... select * from test order by id;
... &quot;&quot;&quot;
&gt;&gt;&gt;
&gt;&gt;&gt; queries = aiosql.from_str(sql_str, &quot;psycopg2&quot;)
&gt;&gt;&gt; conn = psycopg2.connect(&quot;dbname=test user=postgres&quot;)
&gt;&gt;&gt; queries.create_schema(conn)
&gt;&gt;&gt;
&gt;&gt;&gt; cur = conn.cursor()
&gt;&gt;&gt; execute_values(cur, queries.insert.sql, [(1, 2, 3), (4, 5, 6), (7, 8, 9)])
&gt;&gt;&gt; execute_values(cur, queries.update.sql, [(1, 20), (4, 50)])
&gt;&gt;&gt;
&gt;&gt;&gt; queries.getem(conn)
[(1, 20, 3), (4, 50, 6), (7, 8, 9)])
</code></pre>

<h2 id="sync-async">Sync &amp; Async<a class="headerlink" href="#sync-async" title="Permanent link">&para;</a></h2>
<p>Below are two example of a program which can print <code>"{greeting}, {world_name}!"</code> from data held in a minimal SQLite database containing greetings and worlds. They use this same sql.</p>
<p><em>greetings.sql</em></p>
<pre><code class="sql">-- name: get-all-greetings
-- Get all the greetings in the database
select greeting_id,
       greeting
  from greetings;

-- name: get-worlds-by-name^
-- Get the world record from the database.
select world_id,
       world_name
  from worlds
 where world_name = :world_name;
</code></pre>

<p>Notice there is a usage of the <a href="../defining-sql-queries/#select-one"><code>^</code> Select One Query Operator</a>. Adding this to the SQL comment <code>--name: get-world-by-name^</code> indicates to aiosql that <code>queries.get_world_by_name()</code> will return a single row back.</p>
<h3 id="sync-with-sqlite3">Sync with sqlite3<a class="headerlink" href="#sync-with-sqlite3" title="Permanent link">&para;</a></h3>
<p>Here we've set up our <code>sqlite3</code> connection. Using the <code>sqlite3.Row</code> type for our records to make it easy to access values by column names rather than as tuple indices. The program works, it does two queries sqequentially then loops over their results to print greetings.</p>
<pre><code class="python">import sqlite3
import aiosql

queries = aiosql.from_path(&quot;greetings.sql&quot;, driver_adapter=&quot;sqlite3&quot;)

conn = sqlite3.connect(&quot;greetings.db&quot;)
conn.row_factory = sqlite3.Row

# greetings = [
#     &lt;Row greeting_id=1, greeting=&quot;Hi&quot;&gt;,
#     &lt;Row greeting_id=2, greeting=&quot;Aloha&quot;&gt;,
#     &lt;Row greeting_id=3, greeting=&quot;Hola&quot;&gt;
# ]
greetings = queries.get_all_greetings(conn)

# world = &lt;Row world_id=1, world_name=&quot;Earth&quot;&gt;
world = queries.get_worlds_by_name(conn, world_name=&quot;Earth&quot;)

# Hi, Earth!
# Aloha, Earth!
# Hola, Earth!
for greeting_row in greetings:
    print(f&quot;{greeting_row['greeting']}, {world['world_name']}!&quot;)

conn.close()
</code></pre>

<h3 id="asyncio-with-aiosqlite">Asyncio with aiosqlite<a class="headerlink" href="#asyncio-with-aiosqlite" title="Permanent link">&para;</a></h3>
<p>This program is only a little bit different. It let's us leverage <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.gather"><code>asyncio.gather</code></a> to make both queries for greetings and worlds in parallel!</p>
<pre><code class="python">import asyncio

import aiosql
import aiosqlite


queries = aiosql.from_path(&quot;greetings.sql&quot;, driver_adapter=&quot;aiosqlite&quot;)

async def main():
    with async aiosqlite.connect(&quot;greetings.db&quot;) as conn:
        conn.row_factory = aiosqlite.Row
        # Parallel queries!!!
        #
        # greetings = [
        #     &lt;Row greeting_id=1, greeting=&quot;Hi&quot;&gt;,
        #     &lt;Row greeting_id=2, greeting=&quot;Aloha&quot;&gt;,
        #     &lt;Row greeting_id=3, greeting=&quot;Hola&quot;&gt;
        # ]
        # world = &lt;Row world_id=1, world_name=&quot;Earth&quot;&gt;
        greeting_rows, world = await asyncio.gather(
            queries.get_all_greetings(conn),
            queries.get_worlds_by_name(conn, world_name=&quot;Earth&quot;)
        )

        # Hi, Earth!
        # Aloha, Earth!
        # Hola, Earth!
        for greeting_row in greeting_rows:
            print(f&quot;{greeting_row['greeting']}, {world['world_name']}!&quot;)


asyncio.run(main())
</code></pre>

<p>Slightly different usage with <a href="https://github.com/omnilib/aiosqlite">aiosqlite</a> but I hope this has demonstrated in a small way the big power and performance possibilities with asyncronous queries using the async driver types.</p>
<h2 id="type-hinting-queries-with-protocols">Type Hinting Queries with Protocols<a class="headerlink" href="#type-hinting-queries-with-protocols" title="Permanent link">&para;</a></h2>
<p>Todo</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../database-driver-adapters/" class="btn btn-neutral float-right" title="Database Driver Adapters">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../defining-sql-queries/" class="btn btn-neutral" title="Defining SQL Queries"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright 2018-2020, William Vaughn</p>
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/nackjicholson/aiosql/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../defining-sql-queries/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../database-driver-adapters/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
